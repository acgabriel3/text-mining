---
title: "SBRT Respostas"
author: ''
output:
  flexdashboard::flex_dashboard:
    orientation: rows
runtime: shiny
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(tidytext)
library(dplyr)
library(dendextend)
library(shinyWidgets)
library(dplyr)
library(stringr)
library(flexdashboard)
library(shiny)



#library(biclust)
load("/home/micael/repositorios/github/textmining-sbrt/relatorio_resposta/base/sbrt_vis_10.RData")
set.seed(1)

#Seleção dos 100 dossiês mais relevantes por tópico.
respostas_topic<-respostas_topic %>%
  group_by(topic) #%>% slice(1:100)
respostas_topic$periodo<-gsub(regex("(\\d+/\\d+/)", dotall = TRUE),"",respostas_topic$DATA_CRIACAO)%>%
as.numeric()
#names(respostas_topic)<-c("Resposta", "Título", "Categoria atual do SBRT", "Assunto", "topic", "Gamma")

#Seleção dos 1000 termos mais relevantes por tópico.
terms_sbrt<-terms_sbrt%>%
  group_by(topic) %>% slice(1:1000)%>%
  ungroup()
names(terms_sbrt)<-c("topic", "Termo", "Beta")

respostas_total<-nrow(respostas_topic)
periodo<- respostas_topic$periodo%>%unique()%>%sort()
topics_selector<-as.list(1:length(labels_topics_selector))
names(topics_selector)<-labels_topics_selector
```

Inputs {.sidebar}
====================================================================================


```{r include=FALSE}
dropdownButton <- function(label = "", status = c("default", "primary", "success", "info", "warning", "danger"), ..., width = NULL) {

  status <- match.arg(status)
  # dropdown button content
  html_ul <- list(
    class = "dropdown-menu",
    style = if (!is.null(width)) 
      paste0("width: ", validateCssUnit(width), ";"),
    lapply(X = list(...), FUN = tags$li, style = "margin-left: 10px; margin-right: 10px;")
  )
  # dropdown button apparence
  html_button <- list(
    class = paste0("btn btn-", status," dropdown-toggle"),
    type = "button", 
    `data-toggle` = "dropdown"
  )
  html_button <- c(html_button, list(label))
  html_button <- c(html_button, list(tags$span(class = "caret")))
  # final result
  tags$div(
    class = "dropdown",
    do.call(tags$button, html_button),
    do.call(tags$ul, html_ul),
    tags$script(
      "$('.dropdown-menu').click(function(e) {
      e.stopPropagation();
});")
  )
  }
```



```{r include=FALSE}
#obervers para o checkbox dos estados
  #output$res1 <- renderPrint({
  #  input$check1
  #})

  # Sorting asc
  observeEvent(input$a2z, {
    updateCheckboxGroupInput(
      session = session, inputId = "check2", choices = unique(respostas_topic$UF_ORIG), selected = input$check2
    )
  })
  # Sorting desc
  observeEvent(input$z2a, {
    updateCheckboxGroupInput(
      session = session, inputId = "check2", choices = rev(unique(respostas_topic$UF_ORIG)), selected = input$check2
    )
  })
  output$res2 <- renderPrint({
    input$check2
  })
  # Select all / Unselect all
  observeEvent(input$all, {
    if (is.null(input$check2)) {
      updateCheckboxGroupInput(
        session = session, inputId = "check2", selected = unique(respostas_topic$UF_ORIG)
      )
    } else {
      updateCheckboxGroupInput(
        session = session, inputId = "check2", selected = ""
      )
    }
  })
```



```{r include=FALSE}
#obervers para o checkbox das instituicoes
  #output$res1 <- renderPrint({
  #  input$check1
  #})

  # Sorting asc
  observeEvent(input$a2z, {
    updateCheckboxGroupInput(
      session = session, inputId = "check3", choices = unique(respostas_topic$INST), selected = input$check3
    )
  })
  # Sorting desc
  observeEvent(input$z2a, {
    updateCheckboxGroupInput(
      session = session, inputId = "check3", choices = rev(unique(respostas_topic$INST)), selected = input$check3
    )
  })
  output$res2 <- renderPrint({
    input$check3
  })
  # Select all / Unselect all
  observeEvent(input$all_inst, {
    if (is.null(input$check3)) {
      updateCheckboxGroupInput(
        session = session, inputId = "check3", selected = unique(respostas_topic$INST)
      )
    } else {
      updateCheckboxGroupInput(
        session = session, inputId = "check3", selected = ""
      )
    }
  })
```


```{r}
 selectInput("topicnum", label = "Selecione um ou mais tópicos", 
    choices=topics_selector,
    #choices=list("1"=1,"2"=2),

    selected = topics_selector[[1]])
```



```{r}
fluidPage(
  tags$h5(""),
  #br(),
  fluidRow(
    column(
      width = 6,
      dropdownButton(
        label = "Estados", status = "default", width = 80,
        actionButton(inputId = "a2z", label = "A - Z", icon = icon("sort-alpha-asc")),
        actionButton(inputId = "z2a", label = "Z - A", icon = icon("sort-alpha-desc")),
        br(),
        actionButton(inputId = "all", label ="Todos/Nenhum"),
        checkboxGroupInput(inputId = "check2", label = "Selecione", choices =unique(respostas_topic$UF_ORIG), selected = unique(respostas_topic$UF_ORIG)
      )#,
      #verbatimTextOutput(outputId = "res2")
    )
  )
)
)
```



```{r}
fluidPage(
  tags$h5(""),
  #br(),
  fluidRow(
    column(
      width = 6,
      dropdownButton(
        label = "Instituicoes", status = "default", width = 80,
        actionButton(inputId = "a2z", label = "A - Z", icon = icon("sort-alpha-asc")),
        actionButton(inputId = "z2a", label = "Z - A", icon = icon("sort-alpha-desc")),
        br(),
        actionButton(inputId = "all_inst", label = "Todos/Nenhum"),
        checkboxGroupInput(inputId = "check3", label = "Selecione", choices =unique(respostas_topic$INST), selected = unique(respostas_topic$INST)
      )#,
      #verbatimTextOutput(outputId = "res2")
    )
  )
)
)
```


```{r}
basicPage(sliderInput("ano", "Ano",min = min(periodo), max = max(periodo), value = c(min(periodo),max(periodo)),sep=""))


```


```{r eval=FALSE, include=FALSE}
basicPage(
 selectInput("numresultados", label = "Selecione o número de resultados a serem exibidos", 
    choices=c(100,200,300),
    #choices=list("1"=1,"2"=2),

    selected = 100))
```



Visualização interativa dos documentos e termos por tópico.

Clique [aqui](https://micaelfilipee.github.io/sbrt_topics/respostas/40/index.html) para visualizar o modelo LDA utilizado para identtificação dos tópicos. 


Documentos
====================================================================================

Row
-----------------------------------------------------------------------
### Respostas Selecionadas


```{r include=FALSE}
#inputs
num <- reactive(as.integer(input$topicnum))
uf<-reactive(input$check2)
insti<-reactive(input$check3)
ano_inicio<-reactive(as.numeric(input$ano[1]))
ano_fim<-reactive(as.numeric(input$ano[2]))
categoria<-reactive(input$categ)
```


```{r}
renderValueBox(
valueBox(as.character(respostas_n()), icon = "fa-file-alt"))
```

### Proporção do total de respostas do tópico
```{r}
porcentagem<-reactive({round(respostas_n()/n_respostas_topico()*100,digits = 2)})
renderGauge(
  #per<-round(respostas_total/respostas_n()*100),
  gauge(porcentagem(), min = 0, max = 100, symbol = '%')
)
```




Row {.tabset}
-----------------------------------------------------------------------

### Respostas do tópico

```{r}
respostas_tbl<-reactive({respostas_topic%>%
  filter(topic==num())%>%
  filter(UF_ORIG %in% uf())%>%
  filter(INST %in% insti())%>%
  #filter(periodo>=ano_inicio()|periodo<=ano_fim())%>%
  filter(periodo>=ano_inicio())%>%
  filter(periodo<=ano_fim())%>%
  #filter(str_detect(DATA_CRIACAO, regex("(\\d+/\\d+/2008)", dotall = TRUE)))%>%
  #filter(`Categoria atual do SBRT` %in% categoria() )%>%
  ungroup()%>%
  select(-topic, -AUTOR_QT,-COD_QT,-CNAE_SUB_RT,-periodo)
})

n_respostas_topico<-reactive({respostas_topic%>%
  filter(topic==num())%>%nrow()})
```


```{r eval=FALSE, include=FALSE}
# only display table for values in cluster 4
#n.topic<-num()
renderTable(
respostas_tbl(),digits=0

)
```


```{r}
# only display table for values in cluster 4
#n.topic<-num()
#library(DT)
#options(DT.fillContainer = FALSE) 
#options(DT.autoHideNavigation = FALSE) 
#

renderDataTable({
DT::datatable(respostas_tbl(),
              fillContainer = TRUE,
              autoHideNavigation = FALSE,
              colnames=c("ID", "Origem da solicitação","Intituição Responsável", 
                         "CNAE subclasse descrição", "Titulo da RT", "Descrição da RT",
                         "Data de criação", "Gamma"),
              options = list(scrollY='400px',
                             scrollX='400px',
                             bPaginate = TRUE,
                               language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
                             columnDefs = list(list(className = 'dt-center', 
                                                    targets = 1:8))))%>%
    formatRound(columns=c("gamma"), digits=3)%>%
  formatStyle(c("document", "UF_ORIG", "INST", "CNAE_SUB_DESCR", "TITULO_RT", "DESCR_RT", "DATA_CRIACAO", "gamma"), `text-align` = "center")
})

```

```{r include=FALSE}
respostas_n<-reactive({
  
  as.numeric(respostas_tbl()%>%ungroup()%>%nrow())

})

```



### Dendrograma




Termos
====================================================================================


Row
-----------------------------------------------------------------------

### Dendograma
    
```{r}
num <- reactive(as.integer(input$topicnum))

renderPlot({
par(mar = c(0,0,0,0))
dendrograma_terms %>% 
  set("branches_k_color", k = best_topic)%>% 
  set("labels_cex", 1) %>%
  set("leaves_cex",0.2)%>%
  set("hang_leaves",0.1)%>%
  set("branches_lwd", 2)%>%
  plot(horiz=T, axes=F)
})

```






Row {.tabset}
-----------------------------------------------------------------------



### Hierarquia dos termos
    
```{r}
renderTable(
terms_sbrt%>%
  filter(topic==num())%>%
  select(-topic)#, digits=6
)
```



